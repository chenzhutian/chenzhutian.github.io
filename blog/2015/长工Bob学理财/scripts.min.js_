var FundFlow=function(){function t(t,e){var s=this;this.viewHeight=.7*window.innerHeight,this.originalX=30,this.originalY=.5*this.viewHeight,this.focusX=this.originalX,this.focusY=0,this.focusHeight=.7*this.viewHeight,this.contextX=this.originalX,this.contextY=.78*this.viewHeight,this.contextHeight=.15*this.viewHeight,this.incomesNum=0,this.outcomesNum=0,this.begDate=new Date(2015,8,1),this.endDate=new Date(2017,9,1),this.DateDiff={inDays:function(t,e){var s=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()),a=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());return Math.floor((a-s)/1e3*60*60*24)},inWeeks:function(t,e){var s=Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()),a=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate());return Math.floor((a-s)/24*3600*1e3*7)},inMonths:function(t,e){var s=t.getFullYear(),a=e.getFullYear(),i=t.getMonth(),n=e.getMonth();return n+12*a-(i+12*s)},inYears:function(t,e){return e.getFullYear()-t.getFullYear()}},this.d3Element=d3.select(t),this.svg=this.d3Element.insert("svg",":first-child").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+document.body.clientWidth+" "+this.viewHeight),this.viewWidth=document.body.clientWidth-48-0,this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",this.viewWidth).attr("height",this.focusHeight),this.focusRegion=this.svg.append("g").attr("class","focus").attr("transform","translate("+[this.focusX,this.focusY]+")"),this.contextRegion=this.svg.append("g").attr("class","context").attr("transform","translate("+[this.contextX,this.contextY]+")"),this.focusYScale=d3.scale.linear().range([this.focusHeight,10]).domain([-1e3,1e3]),this.contextYScale=d3.scale.linear().range([this.contextHeight,0]).domain([-1e3,1e3]),this.focusYAxis=d3.svg.axis().scale(this.focusYScale).tickSize(-this.viewWidth).tickFormat(d3.format("s")).orient("left"),this.focusYAxisSvg=this.focusRegion.append("g").attr("class","y axis").call(this.focusYAxis),this.focusXScale=d3.time.scale().range([0,this.viewWidth]).domain([this.begDate,this.endDate]),this.contextXScale=d3.time.scale().range([0,this.viewWidth]).domain([this.begDate,this.endDate]),this.focusXAxis=d3.svg.axis().ticks(function(t,e){var s=e-t;return 3888e6>s?d3.time.weeks(t,e):d3.time.months(t,e,2)}).tickFormat(d3.time.format.multi([[".%L",function(t){return t.getMilliseconds()}],[":%S",function(t){return t.getSeconds()}],["%I:%M",function(t){return t.getMinutes()}],["%I %p",function(t){return t.getHours()}],["%a %d",function(t){return t.getDay()&&1!=t.getDate()}],["%b %d",function(t){return 1!=t.getDate()}],["%m",function(t){return t.getMonth()}],["%Y.%m",function(){return!0}]])).scale(this.focusXScale).orient("bottom"),this.contextXAxis=d3.svg.axis().ticks(function(t,e){return s.viewWidth>500?d3.time.months(t,e):s.viewWidth>250?d3.time.months(t,e,2):d3.time.months(t,e,3)}).tickFormat(d3.time.format.multi([[".%L",function(t){return t.getMilliseconds()}],[":%S",function(t){return t.getSeconds()}],["%I:%M",function(t){return t.getMinutes()}],["%I %p",function(t){return t.getHours()}],["%a %d",function(t){return t.getDay()&&1!=t.getDate()}],["%b %d",function(t){return 1!=t.getDate()}],["%m",function(t){return t.getMonth()}],["%Y.%m",function(){return!0}]])).scale(this.contextXScale).orient("bottom"),this.focusArea=d3.svg.area().interpolate("monotone").x(function(t){return s.focusXScale(t.date)}).y0(function(){return s.focusYScale(0)}).y1(function(t){return s.focusYScale(t.amount)}),this.contextArea=d3.svg.area().interpolate("monotone").x(function(t){return s.contextXScale(t.date)}).y0(function(){return s.contextYScale(0)}).y1(function(t){return s.contextYScale(t.amount)}),this.focusAreaSvg=this.focusRegion.append("g").attr("class","refound").append("path").attr("class","area").attr("d",""),this.contextAreaSvg=this.contextRegion.append("g").attr("class","refound").append("path").attr("class","area").attr("d",""),this.focusXAxisSvg=this.focusRegion.append("g").attr("class","x axis").attr("transform","translate("+[0,this.focusYScale(0)]+")").call(this.focusXAxis),this.focusXAxisSvg.selectAll("g.tick").each(function(t){var e=d3.select(this);if(!e.empty()){var s=e.select("text");s.empty()||/\d+\.\d+/.test(s.text())&&(e.select("text").attr("y",20),e.select("line").attr("y2",15))}}),this.contextXAxisSvg=this.contextRegion.append("g").attr("class","x axis").attr("transform","translate("+[0,this.contextYScale(0)]+")").call(this.contextXAxis),this.contextXAxisSvg.selectAll("g.tick").each(function(t){var e=d3.select(this);if(!e.empty()){var s=e.select("text");s.empty()||/\d+\.\d+/.test(s.text())&&(e.select("text").attr("y",15),e.select("line").attr("y2",15))}}),this.focusLine=d3.svg.line().interpolate("monotone").x(function(t){return s.focusXScale(t.date)}).y(function(t){return s.focusYScale(t.amount)}),this.contextLine=d3.svg.line().interpolate("monotone").x(function(t){return s.contextXScale(t.date)}).y(function(t){return s.contextYScale(t.amount)}),this.focusFoundFlowLine=this.focusRegion.select("g.refound").append("path").attr("d","").attr("class","border"),this.contextFoundFlowLine=this.contextRegion.select("g.refound").append("path").attr("d","").attr("class","border"),this.brush=d3.svg.brush().x(this.contextXScale).on("brush",function(){s.brush.empty()?s.focusXScale.domain(s.contextXScale.domain()):s.focusXScale.domain(s.brush.extent()),s.focusFoundFlowLine.attr("d",s.focusLine),s.focusAreaSvg.attr("d",s.focusArea),s.focusXAxisSvg.call(s.focusXAxis),s.focusXAxisSvg.selectAll("g.tick").each(function(t){var e=d3.select(this);if(!e.empty()){var s=e.select("text");s.empty()||/\d+\.\d+/.test(s.text())&&(e.select("text").attr("y",20),e.select("line").attr("y2",15))}})}),this.brushSvg=this.contextRegion.append("g").attr("class","x brush").call(this.brush),this.brushSvg.selectAll("rect").attr("height",this.contextHeight),this.focusFocusCircle=this.focusRegion.append("g").attr("class","focusCircle").style("display","none"),this.focusFocusCircle.append("circle").attr("r",4.5),this.focusFocusCircle.append("text").attr("class","amount").attr("dy",".35em"),this.focusFocusCircle.append("text").attr("class","date").attr("dy","1.35em"),this.bisectDate=d3.bisector(function(t){return t.date}).left,this.formatCurrency=function(t){return"$"+d3.format(",.2f")(t)},this.focusOverlay=this.focusRegion.append("rect").attr("class","overlay").attr("width",this.viewWidth).attr("height",this.focusHeight).on("mouseover",function(){s.focusFocusCircle.style("display",null)}).on("mouseout",function(){s.focusFocusCircle.style("display","none")}).on("mousemove",function(){var t=s.focusXScale.invert(d3.mouse(s.focusOverlay.node())[0]),e=s.bisectDate(s.refound,t,1);if(!(e>=s.refound.length||0==e)){var a=s.refound[e-1],i=s.refound[e],n=t.getTime()-a.date.getTime()>i.date.getTime()-t.getTime()?i:a;s.focusFocusCircle.attr("transform","translate("+s.focusXScale(n.date)+","+s.focusYScale(n.amount)+")"),e<=.5*s.refound.length?(s.focusFocusCircle.select("text.amount").attr("x",9).style("text-anchor","start").text(s.formatCurrency(n.amount)),s.focusFocusCircle.select("text.date").attr("x",9).style("text-anchor","start").text(d3.time.format("%Y-%m-%d")(n.date))):(s.focusFocusCircle.select("text.amount").attr("x",-9).style("text-anchor","end").text(s.formatCurrency(n.amount)),s.focusFocusCircle.select("text.date").attr("x",-9).style("text-anchor","end").text(d3.time.format("%Y-%m-%d")(n.date)))}}),this.GetTransactionFromTextFile(e)}return t.prototype.Render=function(){if(this.refound=this.GetRefound(this.incomes,this.outcomes),this.refound){var t=1e3,e=this.focusYScale.domain(),s=d3.extent(this.refound,function(t){return t.amount});this.focusYScale(0);s[0]<e[0]||s[1]>e[1]?this.focusYScale.domain([d3.min([s[0],e[0]]),d3.max([s[1],e[1]])]):(s[0]>e[0]/2||s[1]<e[1]/2)&&this.focusYScale.domain([d3.min([-1e3,s[0]]),d3.max([1e3,s[1]])]),this.contextYScale.domain(this.focusYScale.domain()),this.focusYAxis.scale(this.focusYScale),this.focusYAxisSvg.transition().duration(t).call(this.focusYAxis),this.focusXAxisSvg.transition().duration(t).attr("transform","translate("+[0,this.focusYScale(0)]+")"),this.contextXAxisSvg.transition().duration(t).attr("transform","translate("+[0,this.contextYScale(0)]+")"),this.focusFoundFlowLine.datum(this.refound).transition().duration(t).attr("d",this.focusLine),this.contextFoundFlowLine.datum(this.refound).transition().duration(t).attr("d",this.contextLine),this.focusAreaSvg.datum(this.refound).transition().duration(t).attr("d",this.focusArea),this.contextAreaSvg.datum(this.refound).transition().duration(t).attr("d",this.contextArea);var a=this.refound[this.refound.length-1];a&&(this.focusFocusCircle.attr("transform","translate("+this.focusXScale(a.date)+","+this.focusYScale(a.amount)+")").style("display",null),this.focusFocusCircle.select("text.amount").attr("x",-9).style("text-anchor","end").text(this.formatCurrency(a.amount)),this.focusFocusCircle.select("text.date").attr("x",-9).style("text-anchor","end").text(d3.time.format("%Y-%m-%d")(a.date)))}},t.prototype.GetTransactionFromTextFile=function(t){var e=this;this.incomes=new Array,this.outcomes=new Array,t.income.forEach(function(t){var s,a,i,n,o;if(""!==t.amount&&(s=+t.amount,""!==t.date&&(a=new Date(t.date),""!==t.intervalTimes&&(i=+t.intervalTimes,""!==t.interval&&(n=t.interval,""!==t.times&&(o=+t.times,!(0>=o)))))))for(e.incomes.push({date:a,amount:s,name:t.name,id:"income_"+e.incomesNum++ +"_"+a.getTime()});--o>0;){switch(n){case"Day":a=d3.time.day.offset(a,+i);break;case"Week":a=d3.time.week.offset(a,+i);break;case"Month":var r=a.getMonth();a=d3.time.month.offset(a,+i),(a.getMonth()===r+2||1===a.getMonth()&&11===r)&&(a.setDate(1),a=d3.time.day.offset(a,-1));break;case"Year":a=d3.time.year.offset(a,+i)}e.incomes.push({date:a,amount:s,name:"",id:"income_"+e.incomesNum++ +"_"+a.getTime()})}}),t.outcome.forEach(function(t){var s,a,i,n,o;if(""!==t.amount&&(s=+t.amount,""!==t.date&&(a=new Date(t.date),""!==t.intervalTimes&&(i=+t.intervalTimes,""!==t.interval&&(n=t.interval,""!==t.times&&(o=+t.times,!(0>=o)))))))for(e.outcomes.push({date:a,amount:s,name:"",id:"outcome_"+e.outcomesNum++ +"_"+a.getTime()});--o>0;){switch(n){case"Day":a=d3.time.day.offset(a,+i);break;case"Week":a=d3.time.week.offset(a,+i);break;case"Month":var r=a.getMonth();a=d3.time.month.offset(a,+i),(a.getMonth()===r+2||1===a.getMonth()&&11===r)&&(a.setDate(1),a=d3.time.day.offset(a,-1));break;case"Year":a=d3.time.year.offset(a,+i)}e.outcomes.push({date:a,amount:s,name:"",id:"outcome_"+e.outcomesNum++ +"_"+a.getTime()})}}),t.investigate.forEach(function(t){var s,a,i,n,o,r,c,u;if(""!==t.amount&&(s=+t.amount,""!==t.date&&(a=new Date(t.date),i=""===t.earningRatio?0:+t.earningRatio,n=""===t.endDate?d3.time.day.offset(e.endDate,-1):new Date(t.endDate),""===t.isTheSameEndDate?o=!1:"string"==typeof t.isTheSameEndDate?o="true"===t.isTheSameEndDate:"boolean"==typeof t.isTheSameEndDate&&(o=t.isTheSameEndDate),""!==t.intervalTimes&&(r=+t.intervalTimes,""!==t.interval&&(c=t.interval,""!==t.times&&(u=+t.times,!(0>=u||e.DateDiff.inDays(a,n)<1))))))){e.outcomes.push({date:a,amount:s,name:t.name,id:"outcome_"+e.outcomesNum++ +"_"+a.getTime()});var l=1;switch(t.earningRatioUnit){case"Day":l=e.DateDiff.inDays(a,n);break;case"Week":l=e.DateDiff.inWeeks(a,n);break;case"Month":l=e.DateDiff.inMonths(a,n);break;case"Year":l=e.DateDiff.inYears(a,n);break;default:l=1}for(e.incomes.push({date:n,amount:s*Math.pow(1+i,l),name:t.name,id:"intcome_"+e.incomesNum++ +"_"+a.getTime()});--u>0;){switch(a>n&&(o=!1),c){case"Day":a=d3.time.day.offset(a,+r),n=o?n:d3.time.day.offset(n,+r);break;case"Week":a=d3.time.week.offset(a,+r),n=o?n:d3.time.week.offset(n,+r);break;case"Month":var d=a.getMonth();a=d3.time.month.offset(a,+r),(a.getMonth()===d+2||1===a.getMonth()&&11===d)&&(a.setDate(1),a=d3.time.day.offset(a,-1));var f=n.getMonth();n=o?n:d3.time.month.offset(n,+r),(!o&&n.getMonth()===f+2||1===n.getMonth()&&11===f)&&(n.setDate(1),n=d3.time.day.offset(n,-1));break;case"Year":a=d3.time.year.offset(a,+r),n=o?n:d3.time.year.offset(n,+r)}if(!(e.DateDiff.inDays(a,n)<1)){switch(e.outcomes.push({date:a,amount:s,name:"",id:"outcome_"+e.outcomesNum++ +"_"+a.getTime()}),l=1,t.earningRatioUnit){case"Day":l=e.DateDiff.inDays(a,n);break;case"Week":l=e.DateDiff.inWeeks(a,n);break;case"Month":l=e.DateDiff.inMonths(a,n);break;case"Year":l=e.DateDiff.inYears(a,n);break;default:l=1}e.incomes.push({date:n,amount:s*Math.pow(1+i,l),name:t.name,id:"intcome_"+e.incomesNum++ +"_"+a.getTime()})}}}}),e.incomes.sort(function(t,e){return t.date>e.date?-1:1}),e.outcomes.sort(function(t,e){return t.date>e.date?-1:1}),e.Render()},t.prototype.GetRefound=function(t,e){if(t&&e){for(var s=new Array,a=d3.time.day.range(this.begDate,this.endDate),i=0,n=a.length;n>i;++i){for(var o=a[i],r=0,c=0,u=this.incomes.length;u>c;++c)o.getTime()>=this.incomes[c].date.setHours(0)&&(r+=this.incomes[c].amount);s.push({date:o,amount:r,name:"",id:"refound_"+o.getTime()})}for(var i=0,n=s.length;n>i;++i)for(var o=s[i].date,c=0,u=this.outcomes.length;u>c;++c)o.getTime()>=this.outcomes[c].date.setHours(0)&&(s[i].amount-=this.outcomes[c].amount);return s}},t}(),StreamGraph=function(){function t(t,e){var s=[],a=["#045A8D","#2B8CBE","#74A9CF","#A6BDDB","#D0D1E6","#F1EEF6"],i=a[0],n=d3.time.format("%m/%d/%y"),o={top:20,right:40,bottom:30,left:30},r=document.body.clientWidth-o.left-o.right,c=400-o.top-o.bottom,u=d3.select(t).append("div").attr("class","remove").style("position","absolute").style("z-index","20").style("visibility","hidden").style("top","30px").style("left","55px"),l=d3.time.scale().range([0,r]),d=d3.scale.linear().range([c-10,0]),f=d3.scale.ordinal().range(a),h=d3.svg.axis().scale(l).orient("bottom").ticks(d3.time.weeks),m=d3.svg.axis().scale(d),g=(d3.svg.axis().scale(d),d3.layout.stack().offset("silhouette").values(function(t){return t.values}).x(function(t){return t.date}).y(function(t){return t.value})),x=d3.nest().key(function(t){return t.key}),p=d3.svg.area().interpolate("cardinal").x(function(t){return l(t.date)}).y0(function(t){return d(t.y0)}).y1(function(t){return d(t.y0+t.y)}),v=d3.select(t).insert("svg",":first-child").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+(r+o.left+o.right)+" "+(c+o.top+o.bottom)).append("g").attr("transform","translate("+o.left+","+o.top+")");d3.csv(e,function(e){e.forEach(function(t){t.date=n.parse(t.date),t.value=+t.value});var a=g(x.entries(e));l.domain(d3.extent(e,function(t){return t.date})),d.domain([0,d3.max(e,function(t){return t.y0+t.y})]),v.selectAll(".layer").data(a).enter().append("path").attr("class","layer").attr("d",function(t){return p(t.values)}).style("fill",function(t,e){return f(e)}),v.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(h),v.append("g").attr("class","y axis").attr("transform","translate("+r+", 0)").call(m.orient("right")),v.append("g").attr("class","y axis").call(m.orient("left")),v.selectAll(".layer").attr("opacity",1).on("mouseover",function(t,e){v.selectAll(".layer").transition().duration(250).attr("opacity",function(t,s){return s!=e?.6:1})}).on("mousemove",function(t,e){mousex=d3.mouse(this),mousex=mousex[0];var a=l.invert(mousex);a=a.getMonth()+a.getDate();for(var n=t.values,o=0;o<n.length;o++)s[o]=n[o].date,s[o]=s[o].getMonth()+s[o].getDate();mousedate=s.indexOf(a),pro=t.values[mousedate].value,d3.select(this).classed("hover",!0).attr("stroke",i).attr("stroke-width","0.5px"),u.html("<p>"+t.key+"<br>"+pro+"</p>").style("visibility","visible")}).on("mouseout",function(t,e){v.selectAll(".layer").transition().duration(250).attr("opacity","1"),d3.select(this).classed("hover",!1).attr("stroke-width","0px"),u.html("<p>"+t.key+"<br>"+pro+"</p>").style("visibility","hidden")});var o=d3.select(t).append("div").attr("class","remove").style("position","absolute").style("z-index","19").style("width","1px").style("height",v.style("height")+"px").style("top","10px").style("bottom","30px").style("left","0px").style("background","#fff");d3.select(t).on("mousemove",function(){mousex=d3.mouse(this),mousex=mousex[0]+5,o.style("left",mousex+"px")}).on("mouseover",function(){mousex=d3.mouse(this),mousex=mousex[0]+5,o.style("left",mousex+"px")})})}return t}();